<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì–´íœ˜ í•™ìŠµ - BLOSSOM ENGLISH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      color: #111827;
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto 48px;
      padding: 0 16px;
    }

    .main-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-tab {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: #eef1ff;
      color: #111827;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .mode-tab.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.35);
    }

    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 40px 60px 32px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      min-height: 360px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .audio-badge {
      position: absolute;
      top: 18px;
      right: 26px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #e5edff;
      font-size: 12px;
      color: #1d4ed8;
    }

    .center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 12px;
      padding: 10px 8px;
      min-height: 260px; /* ê²°ê³¼ ë¬¸êµ¬ê°€ ë‚˜ì™€ë„ í¬ê²Œ ì•ˆ í”ë“¤ë¦¬ê²Œ */
    }

    .word-big {
      font-size: 72px;
      font-weight: 800;
      color: #b91c1c;
    }

    .meaning-big {
      font-size: 40px;
      font-weight: 700;
      color: #111827;
    }

    .example-en {
      font-size: 18px;
      color: #4b5563;
      margin-top: 18px;
    }

    .example-ko {
      font-size: 16px;
      color: #6b7280;
    }

    .question-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 14px;
    }

    .question-sub {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    .choices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px 24px;
      width: 100%;
      max-width: 620px;
      margin: 0 auto;
    }

    .choice-btn {
      width: 100%;
      min-height: 56px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .choice-btn:hover {
      background: #eef2ff;
    }

    .choice-btn.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
      font-weight: 600;
    }

    .choice-btn.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .sentence-en {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .sentence-ko {
      font-size: 18px;
      color: #4b5563;
      margin-bottom: 18px;
    }

    .sentence-row {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }

    .sentence-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 16px;
    }

    .check-btn {
      padding: 11px 18px;
      border-radius: 999px;
      background: #2563eb;
      border: none;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .hint-text,
    .result-text {
      min-height: 22px;
    }

    .hint-text {
      margin-top: 10px;
      font-size: 14px;
      color: #f97316;
    }

    .result-text {
      margin-top: 6px;
      font-size: 14px;
      color: #4b5563;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      gap: 10px;
      font-size: 14px;
      color: #6b7280;
    }

    .bottom-right {
      display: flex;
      gap: 8px;
    }

    .nav-pill {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill-reset {
      background: #fee2e2;
      color: #b91c1c;
    }

    .pill-back {
      background: #e5e7eb;
      color: #374151;
    }

    @media (max-width: 768px) {
      .card {
        padding: 28px 18px 24px;
      }
      .word-big { font-size: 54px; }
      .meaning-big { font-size: 30px; }
      .sentence-en { font-size: 22px; }
    }
  </style>
</head>
<body>
<div class="page">
  <h1 class="main-title" id="mainTitle">ì–´íœ˜ í•™ìŠµ</h1>

  <div class="top-bar">
    <button class="mode-tab active" data-mode="study">ğŸ“š í•™ìŠµ í•˜ê¸°</button>
    <button class="mode-tab" data-mode="meaning">âœ… ëœ» ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="english">ğŸ”¤ ì˜ì–´ ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="listening">ğŸ§ ë“£ê³  ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="sentence">âœï¸ ë¬¸ì¥ ë¹ˆì¹¸</button>
  </div>

  <div class="card">
    <div class="audio-badge" id="audioBadge">ìë™ìœ¼ë¡œ 2ë²ˆ ë“¤ë ¤ì¤˜ìš”</div>
    <div class="center-area" id="centerArea"></div>

    <div class="bottom-bar">
      <div id="progressText">0 / 0</div>
      <div class="bottom-right">
        <button class="nav-pill pill-reset" id="modeResetBtn">ì´ ëª¨ë“œ ë‹¤ì‹œ ì‹œì‘</button>
        <button class="nav-pill pill-back" id="backToUnitsBtn">ìœ ë‹›ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… ë‹¨ì–´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="words.js"></script>

<script>
  // ---------- URL íŒŒë¼ë¯¸í„° & ë‹¨ì–´ ë°ì´í„° ----------
  const params = new URLSearchParams(window.location.search);
  let stage = params.get("stage") || "1";
  let unitKey = params.get("unit") || "1-1";

  // unit=1 ì²˜ëŸ¼ ìˆ«ìë§Œ ì˜¤ë©´ 1-1ë¡œ ë³´ì •
  if (/^\\d+$/.test(unitKey)) {
    unitKey = unitKey + "-1";
  }

  const WORD_DB = window.WORD_DB || {};
  const words = WORD_DB[unitKey] || [];
  const wordCount = words.length;

  const mainTitle = document.getElementById("mainTitle");
  mainTitle.textContent = `ë‹¨ì–´ í•™ìŠµ ${unitKey}`;

  const centerArea = document.getElementById("centerArea");
  const audioBadge = document.getElementById("audioBadge");
  const progressText = document.getElementById("progressText");
  const modeTabs = document.querySelectorAll(".mode-tab");
  const modeResetBtn = document.getElementById("modeResetBtn");
  const backToUnitsBtn = document.getElementById("backToUnitsBtn");

  let currentMode = "study";
  let currentIndex = 0;

  // ì–´íœ˜ í•™ìŠµìš© ê°„ê²© (ms)
  const STUDY_GAP_BETWEEN_READS = 1200;  // 1ì°¨ ë°œìŒ â†” 2ì°¨ ë°œìŒ ì‚¬ì´
  const STUDY_GAP_AFTER_SECOND  = 3200;  // 2ì°¨ ë°œìŒ í›„ â†’ ë‹¤ìŒ ë‹¨ì–´ê¹Œì§€ ëŒ€ê¸°

  function updateProgress(idx) {
    progressText.textContent = `${idx + 1} / ${wordCount}`;
  }

  function stopSpeech() {
    const synth = window.speechSynthesis;
    if (synth && (synth.speaking || synth.pending)) {
      synth.cancel();
    }
  }

  // ---------- ë°œìŒ 2ë²ˆ + ê°„ê²© ì¡°ì ˆ ----------
  function speakWordTwice(word, afterSecondDone) {
    const synth = window.speechSynthesis;
    if (!synth) {
      if (afterSecondDone) afterSecondDone();
      return;
    }
    synth.cancel();

    const u1 = new SpeechSynthesisUtterance(word);
    const u2 = new SpeechSynthesisUtterance(word);

    u1.lang = "en-US";
    u2.lang = "en-US";
    u1.rate = 0.9;
    u2.rate = 0.9;
    u1.pitch = 1.1;
    u2.pitch = 1.1;

    // ì—¬ì ëª©ì†Œë¦¬ ì¶”ì • voice ì„ íƒ
    const voices = synth.getVoices();
    const female = voices.find(v =>
      v.lang.startsWith("en") &&
      /female|woman|zira|susan|salli|joanna|linda|emma|amy/i.test(v.name)
    );
    if (female) {
      u1.voice = female;
      u2.voice = female;
    }

    u1.onend = () => {
      setTimeout(() => synth.speak(u2), STUDY_GAP_BETWEEN_READS);
    };

    u2.onend = () => {
      if (afterSecondDone) {
        setTimeout(afterSecondDone, STUDY_GAP_AFTER_SECOND);
      }
    };

    synth.speak(u1);
  }

  // ---------- ëª¨ë“œë³„ ë Œë”ë§ ----------

  function renderStudy() {
    stopSpeech();

    if (!words.length) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      audioBadge.style.display = "none";
      progressText.textContent = "0 / 0";
      return;
    }

    const item = words[currentIndex];
    audioBadge.style.display = "inline-flex";
    audioBadge.textContent = "ìë™ìœ¼ë¡œ 2ë²ˆ ë“¤ë ¤ì¤˜ìš”";

    centerArea.innerHTML = `
      <div class="word-big">${item.word}</div>
      <div class="meaning-big">${item.meaning}</div>
      <div class="example-en">${item.exampleEn}</div>
      <div class="example-ko">${item.exampleKo}</div>
      <div style="margin-top:20px;font-size:14px;color:#6b7280;">
        ë‹¨ì–´ì™€ ì˜ˆë¬¸ì„ ë³´ê³  ë“£ê³ , ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ì–´ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
      </div>
    `;
    updateProgress(currentIndex);

    speakWordTwice(item.word, () => {
      if (currentMode !== "study") return;
      currentIndex = (currentIndex + 1) % wordCount;
      renderStudy();
    });
  }

  function makeChoices(correctIndex) {
    const indices = [...Array(wordCount).keys()];
    const others = indices.filter(i => i !== correctIndex);
    for (let i = others.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [others[i], others[j]] = [others[j], others[i]];
    }
    const pick = others.slice(0, 3);
    const all = [correctIndex, ...pick];
    for (let i = all.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [all[i], all[j]] = [all[j], all[i]];
    }
    return all;
  }

  function renderMeaningQuiz() {
    stopSpeech();
    audioBadge.style.display = "none";

    if (!words.length) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      progressText.textContent = "0 / 0";
      return;
    }

    const item = words[currentIndex];

    centerArea.innerHTML = `
      <div class="question-title">${item.word}</div>
      <div class="question-sub">ì˜ì–´ ë‹¨ì–´ë¥¼ ë³´ê³  ì•Œë§ì€ í•œê¸€ ëœ»ì„ ê³¨ë¼ìš”.</div>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";

    makeChoices(currentIndex).forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.meaning;
      btn.onclick = () => {
        if (btn.classList.contains("correct") || btn.classList.contains("wrong")) return;
        if (idx === currentIndex) {
          btn.classList.add("correct");
        } else {
          btn.classList.add("wrong");
        }
      };
      grid.appendChild(btn);
    });

    centerArea.appendChild(grid);
    updateProgress(currentIndex);
  }

  function renderEnglishQuiz() {
    stopSpeech();
    audioBadge.style.display = "none";

    if (!words.length) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      progressText.textContent = "0 / 0";
      return;
    }

    const item = words[currentIndex];

    centerArea.innerHTML = `
      <div class="question-title">${item.meaning}</div>
      <div class="question-sub">í•œê¸€ ëœ»ì„ ë³´ê³  ì•Œë§ì€ ì˜ì–´ë¥¼ ê³¨ë¼ìš”.</div>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";

    makeChoices(currentIndex).forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.word;
      btn.onclick = () => {
        if (btn.classList.contains("correct") || btn.classList.contains("wrong")) return;
        if (idx === currentIndex) {
          btn.classList.add("correct");
        } else {
          btn.classList.add("wrong");
        }
      };
      grid.appendChild(btn);
    });

    centerArea.appendChild(grid);
    updateProgress(currentIndex);
  }

  function renderListeningQuiz() {
    stopSpeech();

    if (!words.length) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      audioBadge.style.display = "none";
      progressText.textContent = "0 / 0";
      return;
    }

    const item = words[currentIndex];
    audioBadge.style.display = "inline-flex";
    audioBadge.textContent = "ë‹¨ì–´ë¥¼ 2ë²ˆ ë“¤ì„ ìˆ˜ ìˆì–´ìš”";

    centerArea.innerHTML = `
      <div class="question-title">ë°œìŒì„ ë“£ê³  ì–´ë–¤ ë‹¨ì–´ì¸ì§€ ë§í˜€ ë³´ì•„ìš”.</div>
      <div class="question-sub">ë¨¼ì € ë°œìŒì„ ë“¤ì–´ë³´ê³ , ì•Œë§ì€ í•œê¸€ ëœ»ì„ ê³¨ë¼ìš”.</div>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";

    makeChoices(currentIndex).forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.meaning;
      btn.onclick = () => {
        if (btn.classList.contains("correct") || btn.classList.contains("wrong")) return;
        if (idx === currentIndex) {
          btn.classList.add("correct");
        } else {
          btn.classList.add("wrong");
        }
      };
      grid.appendChild(btn);
    });

    centerArea.appendChild(grid);
    updateProgress(currentIndex);

    speakWordTwice(item.word, null);
  }

  function renderSentenceQuiz() {
    stopSpeech();
    audioBadge.style.display = "none";

    if (!words.length) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      progressText.textContent = "0 / 0";
      return;
    }

    const item = words[currentIndex];
    const blanked = item.exampleEn.replace(new RegExp(item.word, "i"), "____");

    centerArea.innerHTML = `
      <div class="sentence-en">${blanked}</div>
      <div class="sentence-ko">${item.exampleKo}</div>
    `;

    const row = document.createElement("div");
    row.className = "sentence-row";

    const input = document.createElement("input");
    input.className = "sentence-input";
    input.placeholder = "ì—¬ê¸°ì— ì˜ì–´ ë‹¨ì–´ë¥¼ ì¨ ë³´ì„¸ìš”";

    const checkBtn = document.createElement("button");
    checkBtn.className = "check-btn";
    checkBtn.textContent = "í™•ì¸";

    row.appendChild(input);
    row.appendChild(checkBtn);
    centerArea.appendChild(row);

    const hintArea = document.createElement("div");
    hintArea.className = "hint-text";
    centerArea.appendChild(hintArea);

    const resultArea = document.createElement("div");
    resultArea.className = "result-text";
    centerArea.appendChild(resultArea);

    updateProgress(currentIndex);

    function checkAnswer() {
      const v = input.value.trim().toLowerCase();
      const answer = item.word.toLowerCase();
      if (!v) return;

      if (v === answer) {
        input.style.background = "#f0fdf4";
        input.style.borderColor = "#22c55e";
        resultArea.textContent = "ì •ë‹µì´ì—ìš”! ğŸ‘";
        hintArea.textContent = "";
        setTimeout(() => {
          currentIndex = (currentIndex + 1) % wordCount;
          renderSentenceQuiz();
        }, 900);
      } else {
        input.style.background = "#fef2f2";
        input.style.borderColor = "#f97373";
        const first = answer.charAt(0);
        hintArea.textContent = `íŒíŠ¸: "${first}" ë¡œ ì‹œì‘í•´ìš”.`;
        resultArea.textContent = "ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ ë³¼ê¹Œìš”?";
      }
    }

    checkBtn.onclick = checkAnswer;

    // ì—”í„° / ìŠ¤í˜ì´ìŠ¤ë°”ë¡œë„ ì •ë‹µ í™•ì¸
    input.addEventListener("keydown", (e) => {
      const isEnter = e.key === "Enter" || e.code === "Enter";
      const isSpace = e.key === " " || e.code === "Space";

      if (isEnter || isSpace) {
        e.preventDefault();
        checkAnswer();
      }
    });

    input.focus();
  }

  // ---------- ëª¨ë“œ ì „í™˜ & ì´ˆê¸°í™” ----------

  function renderCurrent() {
    modeTabs.forEach(tab =>
      tab.classList.toggle("active", tab.dataset.mode === currentMode)
    );

    if (!wordCount) {
      centerArea.textContent = "ì´ ìœ ë‹›ì—ëŠ” ì•„ì§ ë‹¨ì–´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.";
      audioBadge.style.display = "none";
      progressText.textContent = "0 / 0";
      return;
    }

    if (currentMode === "study") renderStudy();
    else if (currentMode === "meaning") renderMeaningQuiz();
    else if (currentMode === "english") renderEnglishQuiz();
    else if (currentMode === "listening") renderListeningQuiz();
    else if (currentMode === "sentence") renderSentenceQuiz();
  }

  modeTabs.forEach(tab => {
    tab.onclick = () => {
      currentMode = tab.dataset.mode;
      currentIndex = 0;
      renderCurrent();
    };
  });

  modeResetBtn.onclick = () => {
    currentIndex = 0;
    renderCurrent();
  };

  backToUnitsBtn.onclick = () => {
    location.href = `units-detail.html?stage=${stage}`;
  };

  // ìµœì´ˆ ë Œë”ë§
  renderCurrent();
</script>
</body>
</html>